# 扫描对应的库表去补偿发货单消息

进行补偿，保障流程的可靠性

### 幂等性

调用方，对一个系统进行重复调用（参数全部相同），不论重复调用多少次，这些调用对系统的影响多少相同的效果。就是不论调用我多少次你对我的影响以及你的影响都是不变的，不会随着次数的变化而改变。

>幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。
在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。
幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。
例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的.更复杂的操作幂等保证是利用唯一交易号(流水号)实现.

在这个项目中怎么实现的？

在用户领取的表中添加一个state【活动单使用状态，0未使用，1已使用】状态字段，

分别在两个分库的表 lottery_01.user_take_activity、lottery_02.user_take_activity 中添加 state【活动单使用状态 0未使用、1已使用】 状态字段，这个状态字段用于写入中奖信息到 user_strategy_export_000~003 表中时候，两个表可以做一个幂等性的事务。同时还需要加入 strategy_id 策略ID字段，用于处理领取了活动单但执行抽奖失败时，可以继续获取到此抽奖单继续执行抽奖，而不需要重新领取活动。其实领取活动就像是一种活动镜像信息，可以在控制幂等反复使用

这里活动领取事务用了编程性事务手动去处理。

幂等性怎么去使用，添加一个字段去控制，这里就是用state等于0去控制，执行抽奖流程前，先去判断当前用户是否存在活动单未使用

如果是别的场景，根本就是去判断这个东西是否被使用过，使用唯一标识去判断

### MQ的作用

**怎么去解耦的**


- 系统A只负责把数据写到队列中，谁想要或不想要这个数据(消息)，系统A一点都不关心。
- 即便现在系统D不想要userId这个数据了，系统B又突然想要userId这个数据了，都跟系统A无关，系统A一点代码都不用改。
- 系统D拿userId不再经过系统A，而是从消息队列里边拿。系统D即便挂了或者请求超时，都跟系统A无关，只跟消息队列有关。

这样一来，系统A与系统B、C、D都解耦了。





**问题：消息重复消费、消息丢失、消息的顺序消费**

解决重复消费：用幂等性





在分布式设计情看下，我们会更多的考虑用多个实例来的调度来解决集中的问题，以此提升系统的可靠性。

