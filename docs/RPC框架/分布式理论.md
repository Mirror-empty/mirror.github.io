# 分布式理论


### 分布式理论-CAP

>CAP理论是分布式系统、特别是分布式从存储领域中被讨论的最多的理论。

分布式·系统不可能同时满足一致性（C:Consistency）、可用性（A：Availability）和分区容忍性（P：Partition Tolerance），最多只能同时满足其中两项。

![pSZEiAH.png](https://s1.ax1x.com/2023/01/08/pSZEiAH.png)

###### 一致性

一致性指的是多个数据副本是否能保持一致的特性，在一致性的条件下，系统在执行数据更新操作之后能够从一致性状态转移到另一个一致性状态。

对系统的一个数据更新成功之后，如果所有用户都能都读取最新的值，改系统就被任务具有强一致性。

###### 可用性

可用性指分布式系统在面对各种异常时可以提供正常服务的能力，可以用系统可用时间占总时间的比值来衡量，4个9的可用性表示系统99.99%的时间是可用的。

在可用性条件下，要求系统提供的范围一致处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。

###### 分区容忍性

网络分区指分布式系统中的节点被划分为多个区域，每个区域内部可用通信，但是区域之间无法通信。

在分区容忍性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。

###### 权衡

在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的。因此，CAP 理论实际上是要在可用性和一致性之间做权衡。

可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，

- 为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；
- 为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致。

两个副本位于两个分区，即两个副本之间的网络断开，不能通信。

- 如果允许一个副本更新，则会导致数据不一致，即丧失了c性质。
- 如果为了保证一致性，将某个副本设置不可同来同步数据，这就丧失了a性质。
- 除非两个副本可以互相通信，才能保证c又保证A，这又会导致丧失p性质。


### 分布式理论-BASE

BASE是基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）三个短语的缩写。

##### 基本可用

指分布式系统在出现故障的时候，保证核心可用，允许损失部分可用性。

例如，电商在做促销时，为了保证购物系统的稳定性，部分消费者可能会被引导到一个降级的页面。

##### 软状态

指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即允许系统不同节点的数据副本直接进行同步的过程存在时延。

##### 最终一致性

最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终达到一致的状态。

ACID要求强一致性，通常运用在传统的数据库系统上。而BASE要求最终一致性，通过牺牲强一致性来达到可用性，通常运用在大型分布式系统中。

在实际的分布式场景中，不同业务单元和组件对一致性的要求是不同的，因此ACID和BASE往往会结合在一起使用。



### PACELC 理论


如上所示，CAP理论告诉我们：在系统设计中，这三点只能取其二，一般的分布式系统要求必须有分区容错性。剩下的只能从 C 或者 A 中取舍。但是这个理论并不能很好地应用于实际，首先， A 中是有一定争议的，很长时间才返回，虽然可用，但是业务上可能不能接受。并且，系统大部分时间下，分区都是平稳运行的，并不会出错，在这种情况下，系统设计要均衡的其实是延迟与数据一致性的问题，为了保证数据一致性，写入与读取的延迟就会增高。这就引出了 PACELC 理论。


在出现分区错误的情况下，取前半部分 PAC，理论和 CAP 内容一致。没有出现分区错误的情况下（PACELC 中的 E 代表 Else），取 LC，也就是 Latency（延迟）与 Consistency（一致性）。

![pS8loLt.png](https://s1.ax1x.com/2023/01/19/pS8loLt.png)

现在，其实很多存储，都已经实现了不同的 PACELC 的兼顾策略，并且交由用户配置去灵活根据不同业务场景使用不同的策略。例如：ElasticSearch使用了在写操作上存在Latency和Consistency之间的取舍。

[参考](http://www.mybatis.cn/archives/1463.html)


