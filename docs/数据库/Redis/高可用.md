# 高可用

## 主从复制的实现？

主从复制，读写分离

### 第一次同步

使用 ``replicaof`` 命令 形成主服务器和从服务器的关系

服务器B执行命令 根据输入的Ip地址作为是谁的从服务器

主从服务器间的第一次同步的过程可分为三个阶段：

- 第一阶段是建立链接、协商同步；
  - 从服务器给主服务器发送psync命令，表示进行数据同步
  - psync 命令包含两个参数，分别是主服务器的 runID 和复制进度 offset
  - 主服务器收到 psync 命令后，会用 FULLRESYNC 作为响应命令返回给对方。
  - 并且会带上原先的两个参数，采用全量复制的方式
- 第二阶段是主服务器同步数据给从服务器；
  - 主服务器执行 bgsave 命令生成 RDB文件，产生了一个子进程来执行RDB 这是一个异步工作
  - 在主服务器执行的写操作没有进入从服务器中，会导致数据不一致
  - 主服务器在下面这三个时间间隙中将收到的写操作命令，写入到 replication buffer 缓冲区里：
    - 主服务器生成 RDB 文件期间；
    - 主服务器发送 RDB 文件给从服务器期间；
    - 「从服务器」加载 RDB 文件期间；
- 第三阶段是主服务器发送新写操作命令给从服务器。
  
在主服务器生成的 RDB 文件发送完，从服务器收到 RDB 文件后，丢弃所有旧数据，将 RDB 数据载入到内存。完成 RDB 的载入后，会回复一个确认消息给主服务器。

接着，主服务器将 replication buffer 缓冲区里所记录的写操作命令发送给从服务器，从服务器执行来自主服务器 replication buffer 缓冲区里发来的命令，这时主从服务器的数据就一致了。


### 命令传播

主从以一次同步之后会维护一个TCP连接

后续主服务器可以通过这个连接继续将写操作命令传播给从服务器，然后从服务器执行该命令，使得与主服务器的数据库状态相同。

而且这个连接是长连接的，目的是避免频繁的 TCP 连接和断开带来的性能开销。

上面的这个过程被称为基于长连接的命令传播，通过这种方式来保证第一次同步后的主从服务器的数据一致性。

### 分摊主服务器的压力

由于从服务器太多 只有一个主服务器 

解决：

主服务器只复制给一个从服务器，让这个从服务器复制给别的从服务器。

通过这种方式，主服务器生成 RDB 和传输 RDB 的压力可以分摊到充当经理角色的从服务器。

从服务器使用命令：

`` replicaof <目标服务器的IP> 6379``


### 增量复制

解决 网络断开避免建立连接时 又实现全量复制。

主要有三个步骤：

从服务器在恢复网络后，会发送 psync 命令给主服务器，此时的 psync 命令里的 offset 参数不是 -1；
主服务器收到该命令后，然后用 CONTINUE 响应命令告诉从服务器接下来采用增量复制的方式同步数据；
然后主服务将主从服务器断线期间，所执行的写命令发送给从服务器，然后从服务器执行这些命令。
那么关键的问题来了，主服务器怎么知道要将哪些增量数据发送给从服务器呢？

答案藏在这两个东西里：

- repl_backlog_buffer，是一个「环形」缓冲区，用于主从服务器断连后，从中找到差异的数据；

- replication offset，标记上面那个缓冲区的同步进度，主从服务器都有各自的偏移量，主服务器使用 master_repl_offset 来记录自己「写」到的位置，从服务器使用 slave_repl_offset 来记录自己「读」到的位置。



主从复制的三种模式 全量复制 、基于长连接的命令传播、增量复制

### 面试题

##### 怎么判断 Redis 某个节点是否正常工作？

Redis 判断节点是否正常工作，基本都是通过互相的 ping-pong 心态检测机制，如果有一半以上的节点去 ping 一个节点的时候没有 pong 回应，集群就会认为这个节点挂掉了，会断开与这个节点的连接。

##### 主从切换如何减少数据丢失？

产生数据丢失的两种情况：

- 异步复制同步丢失
- 集群产生脑裂数据丢失

限制从节点的数量



## 哨兵机制的实现？

主节点挂掉，运用算法 重新选取主节点


### 哨兵机制是如何工作的？

哨兵其实是一个运行在特殊模式下的 Redis 进程，所以它也是一个节点。

监控、选主、通知。


### 如何判断主节点真的故障了？

1. 每隔1秒给所有节点发生ping命令，如果有节点没有响应命令，则判定为主观下线。

之所以针对「主节点」设计「主观下线」和「客观下线」两个状态，是因为有可能「主节点」其实并没有故障，可能只是因为主节点的系统压力比较大或者网络发送了拥塞，导致主节点没有在规定时间内响应哨兵的 PING 命令。

所以，为了减少误判的情况，哨兵在部署的时候不会只部署一个节点，而是用多个节点部署成哨兵集群（最少需要三台机器来部署哨兵集群），通过多个哨兵节点一起判断，就可以就可以避免单个哨兵因为自身网络状况不好，而误判主节点下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。

2. 当一个哨兵判断某一个节点为主观下线后，就会向其他哨兵发起命令，进行投票，这个哨兵的赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，就判定为客观下线。

### 有那个哨兵进行主从故障转移？

在哨兵集群中进行投票。

谁找到的问题谁就当候选者。

候选者想当leader 就要投票 超过半数成功选举，因此哨兵集群就需要三个以上。


### 主从故障转移的过程 

主从故障转移操作包含以下四个步骤：

- 第一步：在已下线主节点（旧主节点）属下的所有「从节点」里面，挑选出一个从节点，并将其转换为主节点。
- 第二步：让已下线主节点属下的所有「从节点」修改复制目标，修改为复制「新主节点」；
- 第三步：将新主节点的 IP 地址和信息，通过「发布者/订阅者机制」通知给客户端；
- 第四步：继续监视旧主节点，当这个旧主节点重新上线时，将它设置为新主节点的从节点；


##### 步骤一：选出新主节点

- 第一轮考察：优先级最高的从节点胜出  Redis 有个叫 slave-priority 配置项，可以给从节点设置优先级。

- 第二轮考察：复制进度最靠前的从节点胜出 

- 第三轮考察：ID号小的从节点胜出    每个从节点都有一个编号，这个编号就是 ID 号，是用来唯一标识从节点的。


##### 步骤二：将从节点指向新主节点


当新主节点出现之后，哨兵 leader 下一步要做的就是，让已下线主节点属下的所有「从节点」指向「新主节点」，这一动作可以通过向「从节点」发送 SLAVEOF 命令来实现。

哨兵 leader 向所有从节点（server3和server4）发送 SLAVEOF ，让它们成为新主节点的从节点。


##### 步骤三：通知客户的主节点已更换

经过前面一系列的操作后，哨兵集群终于完成主从切换的工作，那么新主节点的信息要如何通知给客户端呢？

这主要通过 Redis 的发布者/订阅者机制来实现的。每个哨兵节点提供发布者/订阅者机制，客户端可以从哨兵订阅消息。



##### 步骤四：将旧主节点变为从节点

故障转移操作最后要做的是，继续监视旧主节点，当旧主节点重新上线时，哨兵集群就会向它发送 SLAVEOF 命令，让它成为新主节点的从节点


### 哨兵集群是如何组成的？

配置哨兵信息

设置主节点名字、主节点的 IP 地址和端口号以及 quorum 值。

``s
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
``

哨兵节点之间是通过 Redis 的发布者/订阅者机制来相互发现的。

在主从集群中，主节点上有一个名为``__sentinel__:hello``的频道，不同哨兵就是通过它来相互发现，实现互相通信的。

哨兵 A 把自己的 IP 地址和端口的信息发布到__sentinel__:hello 频道上，哨兵 B 和 C 订阅了该频道。那么此时，哨兵 B 和 C 就可以从这个频道直接获取哨兵 A 的 IP 地址和端口号。然后，哨兵 B、C 可以和哨兵 A 建立网络连接。

